name: USDT Deposit Monitor

on:
  schedule:
    # Ð—Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ ÐºÐ°Ð¶Ð´Ñ‹Ðµ 10 Ð¼Ð¸Ð½ÑƒÑ‚
    - cron: '*/10 * * * *'
  # Ð”Ð»Ñ Ñ€ÑƒÑ‡Ð½Ð¾Ð³Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð¸Ð· GitHub UI
  workflow_dispatch:
    inputs:
      log_level:
        description: 'Log level'
        required: false
        default: 'info'
        type: choice
        options:
          - info
          - debug
          - warning

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        # Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ cache, Ñ‚Ð°Ðº ÐºÐ°Ðº Ð½ÐµÑ‚ package-lock.json
    
    - name: Create package.json and install dependencies
      run: |
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ package.json Ñ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÑÐ¼Ð¸
        cat > package.json << 'EOF'
        {
          "name": "deposit-monitor",
          "version": "1.0.0",
          "private": true,
          "dependencies": {
            "ethers": "6.7.0",
            "@supabase/supabase-js": "2.39.0"
          }
        }
        EOF
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ package-lock.json
        npm init -y
        
        # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
        npm install ethers@6.7.0 @supabase/supabase-js@2.39.0 --save
    
    - name: Run USDT Deposit Monitor
      id: monitor
      env:
        BSC_RPC_URL: ${{ secrets.BSC_RPC_URL }}
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        LOG_LEVEL: ${{ inputs.log_level || 'info' }}
      run: |
        cat > monitor.js << 'EOF'
        const { createClient } = require('@supabase/supabase-js');
        const { ethers } = require('ethers');

        // USDT ÐºÐ¾Ð½Ñ‚Ñ€Ð°ÐºÑ‚ Ð½Ð° BSC
        const USDT_ABI = [
          "function balanceOf(address) view returns (uint256)",
          "function decimals() view returns (uint8)"
        ];
        const USDT_ADDRESS = "0x55d398326f99059fF775485246999027B3197955";

        async function runMonitor() {
          console.log('ðŸš€ === USDT DEPOSIT MONITOR STARTED ===');
          console.log('â° Time:', new Date().toISOString());
          console.log('ðŸ”§ Mode:', process.env.LOG_LEVEL || 'info');
          
          try {
            // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
            if (!process.env.BSC_RPC_URL) {
              throw new Error('BSC_RPC_URL not found in environment variables');
            }
            if (!process.env.SUPABASE_URL) {
              throw new Error('SUPABASE_URL not found in environment variables');
            }
            if (!process.env.SUPABASE_SERVICE_ROLE_KEY) {
              throw new Error('SUPABASE_SERVICE_ROLE_KEY not found in environment variables');
            }

            const provider = new ethers.JsonRpcProvider(process.env.BSC_RPC_URL);
            const usdtContract = new ethers.Contract(USDT_ADDRESS, USDT_ABI, provider);
            
            const supabase = createClient(
              process.env.SUPABASE_URL,
              process.env.SUPABASE_SERVICE_ROLE_KEY
            );

            // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð²ÑÐµ Ð°Ð´Ñ€ÐµÑÐ° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
            const { data: profiles, error: profilesError } = await supabase
              .from('profiles')
              .select('deposit_address, id, email, balance');

            if (profilesError) throw profilesError;

            console.log(`ðŸ“Š Checking ${profiles.length} addresses for USDT...`);

            let newDepositsCount = 0;
            let totalChecked = 0;
            const results = [];
            const errors = [];
            
            // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ decimals USDT
            const decimals = await usdtContract.decimals();
            
            // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ USDT Ð±Ð°Ð»Ð°Ð½ÑÑ‹
            for (const profile of profiles) {
              try {
                if (process.env.LOG_LEVEL === 'debug') {
                  console.log(`ðŸ” Checking: ${profile.deposit_address.substring(0, 10)}... (${profile.email})`);
                }
                
                const usdtBalance = await usdtContract.balanceOf(profile.deposit_address);
                const usdtBalanceFormatted = ethers.formatUnits(usdtBalance, decimals);
                const usdtBalanceNumber = parseFloat(usdtBalanceFormatted);
                
                if (process.env.LOG_LEVEL === 'debug') {
                  console.log(`   Balance: ${usdtBalanceFormatted} USDT`);
                }
                
                if (usdtBalance > 0) {
                  // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐµÑÑ‚ÑŒ Ð»Ð¸ ÑƒÐ¶Ðµ Ð´ÐµÐ¿Ð¾Ð·Ð¸Ñ‚ Ð´Ð»Ñ ÑÑ‚Ð¾Ð³Ð¾ Ð°Ð´Ñ€ÐµÑÐ°
                  const { data: existingDeposits } = await supabase
                    .from('deposits')
                    .select('id')
                    .eq('user_id', profile.id)
                    .eq('token_address', USDT_ADDRESS.toLowerCase());

                  if (!existingDeposits || existingDeposits.length === 0) {
                    console.log(`ðŸ’° New deposit detected for ${profile.email}: ${usdtBalanceFormatted} USDT`);
                    
                    // Ð’Ñ‹Ñ‡Ð¸ÑÐ»ÑÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ Ð±Ð°Ð»Ð°Ð½Ñ (Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ null Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ)
                    const currentBalance = profile.balance ? parseFloat(profile.balance) : 0;
                    const newBalance = currentBalance + usdtBalanceNumber;
                    
                    // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð·Ð°Ð¿Ð¸ÑÑŒ Ð¾ Ð´ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ðµ
                    const { error: insertError } = await supabase
                      .from('deposits')
                      .insert([
                        {
                          user_id: profile.id,
                          tx_hash: `manual_${Date.now()}_${profile.id}`,
                          amount: usdtBalance.toString(),
                          amount_usd: usdtBalanceNumber,
                          status: 'confirmed',
                          network: 'bsc',
                          token_address: USDT_ADDRESS.toLowerCase(),
                          token_symbol: 'USDT',
                          confirmations: 12,
                          confirmed_at: new Date().toISOString()
                        }
                      ]);

                    if (!insertError) {
                      // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð±Ð°Ð»Ð°Ð½Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð² profiles
                      const { error: updateError } = await supabase
                        .from('profiles')
                        .update({ 
                          balance: newBalance.toString()
                        })
                        .eq('id', profile.id);

                      if (updateError) {
                        console.error(`âŒ Error updating balance for ${profile.email}:`, updateError.message);
                        errors.push(`Balance update failed for ${profile.email}`);
                        
                        // ÐžÑ‚Ð¼ÐµÐ½ÑÐµÐ¼ Ð´ÐµÐ¿Ð¾Ð·Ð¸Ñ‚ ÐµÑÐ»Ð¸ Ð½Ðµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð±Ð°Ð»Ð°Ð½Ñ
                        await supabase
                          .from('deposits')
                          .delete()
                          .eq('user_id', profile.id)
                          .like('tx_hash', `manual_%_${profile.id}`);
                      } else {
                        newDepositsCount++;
                        results.push({
                          user: profile.email,
                          address: profile.deposit_address,
                          amount: usdtBalanceFormatted,
                          token: 'USDT',
                          old_balance: currentBalance,
                          new_balance: newBalance
                        });
                        console.log(`âœ… Deposit recorded for ${profile.email}. Balance updated: ${currentBalance} â†’ ${newBalance}`);
                      }
                    } else {
                      console.error(`âŒ Error inserting deposit for ${profile.email}:`, insertError.message);
                      errors.push(`Deposit insert failed for ${profile.email}`);
                    }
                  } else {
                    if (process.env.LOG_LEVEL === 'debug') {
                      console.log(`â„¹ï¸  Deposit already exists for ${profile.email}`);
                    }
                  }
                }
                
                totalChecked++;
                
                // Ð—Ð°Ð´ÐµÑ€Ð¶ÐºÐ° Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ð¿Ñ€ÐµÐ²Ñ‹ÑÐ¸Ñ‚ÑŒ Ð»Ð¸Ð¼Ð¸Ñ‚Ñ‹ RPC
                await new Promise(resolve => setTimeout(resolve, 300));
                
              } catch (error) {
                console.error(`âš ï¸  Error checking ${profile.deposit_address}: ${error.message}`);
                errors.push(`Check failed for ${profile.email}: ${error.message}`);
                continue;
              }
            }

            console.log('\n' + '='.repeat(60));
            console.log('ðŸ“ˆ MONITORING REPORT');
            console.log('='.repeat(60));
            console.log(`âœ… Total addresses checked: ${totalChecked}`);
            console.log(`ðŸ’° New deposits found: ${newDepositsCount}`);
            console.log(`â° Completed at: ${new Date().toISOString()}`);
            
            if (results.length > 0) {
              console.log('\nðŸŽ‰ NEW DEPOSITS FOUND:');
              results.forEach((result, index) => {
                console.log(`${index + 1}. ${result.user}: ${result.amount} USDT`);
              });
            }
            
            if (errors.length > 0) {
              console.log('\nâš ï¸  ERRORS ENCOUNTERED:');
              errors.forEach((error, index) => {
                console.log(`${index + 1}. ${error}`);
              });
            }
            
            console.log('\nâœ… === USDT DEPOSIT MONITOR COMPLETED ===\n');
            
          } catch (error) {
            console.error('âŒ CRITICAL ERROR:', error.message);
            console.error('Stack:', error.stack);
            process.exit(1);
          }
        }

        // Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€
        runMonitor();
        EOF
        
        node monitor.js
    
    - name: Save monitoring results as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: deposit-monitor-logs
        path: |
          ${{ github.workspace }}/monitor.js
        retention-days: 7
    
    - name: Create summary report
      if: always()
      run: |
        echo "# ðŸ“Š Deposit Monitor Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Run Date:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Status" >> $GITHUB_STEP_SUMMARY
        if [ "${{ job.status }}" == "success" ]; then
          echo "ðŸŸ¢ **SUCCESS** - Monitor completed successfully" >> $GITHUB_STEP_SUMMARY
        else
          echo "ðŸ”´ **FAILED** - Monitor encountered errors" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "*Check logs for detailed results*" >> $GITHUB_STEP_SUMMARY
        echo "*Report generated automatically by GitHub Actions*" >> $GITHUB_STEP_SUMMARY
